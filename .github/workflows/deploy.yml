name: Deploy Application

on:
  repository_dispatch:
    types: [deploy-application]

  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type DEPLOY to confirm'
        required: true

env:
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  ANSIBLE_FORCE_COLOR: 'true'

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Validate deployment confirmation
        if: github.event.inputs.confirm_deployment != 'DEPLOY'
        run: |
          echo "âŒ Deployment not confirmed!"
          exit 1

      - name: Deployment confirmed
        run: echo "âœ… Deployment confirmed"

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || github.event_name == 'repository_dispatch')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.ANSIBLE_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 \
            ${{ secrets.ANSIBLE_USER }}@${{ secrets.ANSIBLE_HOST }} \
            "echo 'âœ… SSH connection successful'"

      - name: Test Ansible connection
        run: |
          ansible production -i inventory.ini \
            -e "ansible_host=${{ secrets.ANSIBLE_HOST }}" \
            -e "ansible_user=${{ secrets.ANSIBLE_USER }}" \
            -m ping

      - name: Display deployment information
        run: |
          echo "===================================================="
          echo "ðŸš€ DEPLOYMENT"
          echo "===================================================="
          echo "Target: ${{ secrets.ANSIBLE_HOST }}"
          echo "User: ${{ secrets.ANSIBLE_USER }}"
          echo "Path: ${{ secrets.DEPLOYMENT_PATH }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "===================================================="

      - name: Run Ansible deployment
        run: |
          ansible-playbook playbooks/deploy.yml \
            -i inventory.ini \
            -e "ansible_host=${{ secrets.ANSIBLE_HOST }}" \
            -e "ansible_user=${{ secrets.ANSIBLE_USER }}" \
            -e "deployment_path=${{ secrets.DEPLOYMENT_PATH }}" \
            -e "deployment_user=${{ secrets.DEPLOYMENT_USER }}" \
            -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -e "dockerhub_repository=${{ secrets.DOCKERHUB_REPOSITORY }}" \
            -e "dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
            -v

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
